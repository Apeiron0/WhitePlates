<?php namespace App\Http\Controllers;use App\Http\Requests;use App\Http\Controllers\Controller;use App\Models\Platillo;use App\Models\Personal;use App\Models\Orden;use App\Models\Venta;use Auth;use Illuminate\Http\Request;class CajeroController extends Controller {	public function __construct()	{		$this->middleware('cajero');	}	public function getRegistrar(){		$platillos= Platillo::with('subcategoria.categoria')->get();		$personal = Personal::whereHas('puesto', function($q)		{		    $q->where('nombre', '=', 'Mesero');		})->get();		return  view('cajero.nuevaOrden',compact('platillos','personal'));	}	public function getRegistrarexistente(){		return  view('cajero.ordenExistente');	}	public function postRegistrarorden(Request $request){		$this->validate($request, [			'comentario' => 'min:04',		]);		$orden=new Orden;		$orden->comentarios=$request->get('comentarios');		$orden->idpersonal=$request->get('id_personal');		$orden->save();		try{						foreach($request->get('platillos') as $platillo){				$orden->platillos()->attach($platillo['idplatillo'],array('cantidad'=>$platillo['cantidad'],'total'=>$platillo['total']));			}			return array("Msg" =>"Registro Exitoso","Codigo"=>"01","Bandera"=>true);		}catch(Exception $e){			return array("Msg" =>$e->getMessage(),"Codigo"=>$e->getCode(),"Bandera"=>false);		}			}	//Start new events	public function getRegistrarventa(){		$personal = Personal::whereHas('puesto', function($q)		{		    $q->where('nombre', '=', 'Mesero');		})->get();		$ordenes= Orden::doesntHave('ventas')->where('status','=','1')->with('platillos','personal')->get();		return view('cajero.asignarOrden',compact('personal','ordenes'));	}	public function postPlatillos(Request $request){		return Orden::where('id','=',$request->get('id'))->with('platillos')->get();	}	public function postNuevaventa(Request $request){		try{			$venta=new Venta;			$venta->total=$request->get('total');			$venta->fecha=$request->get('fecha');			$venta->personal_id=Auth::user()->personal->id;			$venta->save();			foreach($request->get('ordenes') as $orden){				$venta->ordenes()->attach($orden['idorden']);			}			$ordenes= Orden::doesntHave('ventas')->where('status','=','1')->with('platillos','personal')->get();			return array("Msg" =>"Registro Exitoso","Codigo"=>"01","Bandera"=>true,"Ordenes"=>$ordenes);		}catch(Exception $e){			return array("Msg" =>$e->getMessage(),"Codigo"=>$e->getCode(),"Bandera"=>false);		}			}	}